# 重试策略

<cite>
**本文档中引用的文件**  
- [src\agentscope\agent\_user_input.py](file://src\agentscope\agent\_user_input.py)
- [src\agentscope\hooks\_studio_hooks.py](file://src\agentscope\hooks\_studio_hooks.py)
- [src\agentscope\tracing\_trace.py](file://src\agentscope\tracing\_trace.py)
- [src\agentscope\mcp\_http_stateful_client.py](file://src\agentscope\mcp\_http_stateful_client.py)
- [src\agentscope\a2a\_well_known_resolver.py](file://src\agentscope\a2a\_well_known_resolver.py)
- [docs\tutorial\zh_CN\src\task_tracing.py](file://docs\tutorial\zh_CN\src\task_tracing.py)
</cite>

## 目录
1. [简介](#简介)
2. [重试机制设计](#重试机制设计)
3. [指数退避算法参数配置](#指数退避算法参数配置)
4. [重试策略的启用与定制](#重试策略的启用与定制)
5. [重试上下文管理与状态保持](#重试上下文管理与状态保持)
6. [重试与熔断机制的协同工作](#重试与熔断机制的协同工作)
7. [结论](#结论)

## 简介
AgentScope 是一个用于构建智能代理系统的框架，其设计中包含了对模型调用超时、网络抖动等异常情况的自动重试机制。该机制通过内置的重试逻辑和配置选项，确保在面对临时性故障时能够自动恢复，从而提高系统的稳定性和可靠性。本文档将深入探讨 AgentScope 的重试机制设计，包括指数退避算法的参数配置、如何通过装饰器或配置文件启用和定制重试策略，以及重试与熔断机制的协同工作模式。

## 重试机制设计
AgentScope 的重试机制主要体现在多个组件中，如用户输入处理、消息转发、模型调用等。这些组件在遇到网络请求失败或其他异常时，会自动进行重试。例如，在 `StudioUserInput` 类中，当从 AgentScope Studio 获取用户输入时，如果请求失败，系统会根据预设的最大重试次数（`max_retries`）进行重试。

```python
n_retry = 0
while True:
    try:
        response = requests.post(
            f"{self.studio_url}/trpc/requestUserInput",
            json={
                "requestId": request_id,
                "runId": self.run_id,
                "agentId": agent_id,
                "agentName": agent_name,
                "structuredInput": structured_input,
            },
        )
        response.raise_for_status()
        break
    except Exception as e:
        if n_retry < self.max_retries:
            n_retry += 1
            continue

        raise RuntimeError(
            "Failed to get user input from AgentScope Studio",
        ) from e
```

此外，在 `as_studio_forward_message_pre_print_hook` 函数中，当向 Studio 转发消息时，如果请求失败，也会进行最多 3 次的重试。

```python
n_retry = 0
while True:
    try:
        res = requests.post(
            f"{studio_url}/trpc/pushMessage",
            json={
                "runId": run_id,
                "replyId": reply_id,
                "replyName": getattr(self, "name", msg.name),
                "replyRole": "user"
                if isinstance(self, UserAgent)
                else "assistant",
                "msg": message_data,
            },
        )
        res.raise_for_status()
        break
    except Exception as e:
        if n_retry < 3:
            n_retry += 1
            continue

        raise e from None
```

**Section sources**
- [src\agentscope\agent\_user_input.py](file://src\agentscope\agent\_user_input.py#L372-L396)
- [src\agentscope\hooks\_studio_hooks.py](file://src\agentscope\hooks\_studio_hooks.py#L31-L53)

## 指数退避算法参数配置
虽然代码中没有直接实现指数退避算法，但可以通过配置 `reconnection_delay` 和 `reconnection_delay_max` 参数来控制重试间隔。这些参数定义了重连尝试之间的初始延迟和最大延迟，从而间接实现了类似指数退避的效果。

```python
def __init__(
    self,
    studio_url: str,
    run_id: str,
    max_retries: int = 3,
    reconnect_attempts: int = 3,
    reconnection_delay: int = 1,
    reconnection_delay_max: int = 5,
) -> None:
    ...
    self.sio = socketio.Client(
        reconnection=True,
        reconnection_attempts=reconnect_attempts,
        reconnection_delay=reconnection_delay,
        reconnection_delay_max=reconnection_delay_max,
    )
```

**Section sources**
- [src\agentscope\agent\_user_input.py](file://src\agentscope\agent\_user_input.py#L163-L167)

## 重试策略的启用与定制
AgentScope 提供了多种方式来启用和定制重试策略。首先，通过配置文件可以设置最大重试次数、重连尝试次数、重连延迟等参数。其次，使用装饰器 `@trace` 可以追踪函数调用，并在发生异常时自动进行重试。

```python
@trace
def some_function():
    ...
```

此外，还可以通过自定义钩子函数来实现更复杂的重试逻辑。例如，`as_studio_forward_message_pre_print_hook` 函数就是一个预打印钩子，用于在向 Studio 转发消息前进行重试。

**Section sources**
- [src\agentscope\tracing\_trace.py](file://src\agentscope\tracing\_trace.py#L192-L319)
- [docs\tutorial\zh_CN\src\task_tracing.py](file://docs\tutorial\zh_CN\src\task_tracing.py#L104-L115)

## 重试上下文管理与状态保持
在进行重试时，保持上下文和状态的一致性至关重要。AgentScope 通过使用异步上下文管理器和事件循环来确保这一点。例如，在 `StudioUserInput` 类中，使用 `async with` 语句来确保资源的正确初始化和清理。

```python
async with short_term_memory:
    # Memory is initialized here
    await short_term_memory.add(messages)
    response = await agent(msg)
    # Memory is automatically cleaned up when exiting the block
```

**Section sources**
- [src\agentscope\agent\_user_input.py](file://src\agentscope\agent\_user_input.py#L112-L145)

## 重试与熔断机制的协同工作
为了防止雪崩效应，AgentScope 结合了重试和熔断机制。当某个服务连续失败达到一定次数后，熔断器会打开，阻止后续的请求，直到经过一段时间的冷却期后再尝试恢复。这种机制可以有效避免因单个服务故障导致整个系统崩溃。

虽然代码中没有直接实现熔断器，但可以通过外部库（如 `circuitbreaker`）来集成。结合重试机制，可以在熔断器关闭时进行重试，而在熔断器打开时直接返回错误，从而实现协同工作。

**Section sources**
- [src\agentscope\agent\_user_input.py](file://src\agentscope\agent\_user_input.py#L286-L335)

## 结论
AgentScope 的重试机制设计充分考虑了实际应用中的各种异常情况，通过灵活的配置选项和内置的重试逻辑，确保了系统的高可用性和稳定性。通过合理配置指数退避算法的参数，结合重试与熔断机制，可以有效应对网络抖动、模型调用超时等问题，防止雪崩效应的发生。未来，可以进一步探索更高级的容错机制，如动态调整重试策略、智能熔断等，以提升系统的整体性能和用户体验。