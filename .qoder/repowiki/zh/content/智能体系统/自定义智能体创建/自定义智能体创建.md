# 自定义智能体创建

<cite>
**本文档中引用的文件**   
- [agent_base.py](file://src/agentscope/agent/_agent_base.py)
- [react_agent_base.py](file://src/agentscope/agent/_react_agent_base.py)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py)
- [deep_research_agent.py](file://examples/agent/deep_research_agent/deep_research_agent.py)
- [main.py](file://examples/agent/deep_research_agent/main.py)
- [toolkit.py](file://src/agentscope/tool/_toolkit.py)
- [memory_base.py](file://src/agentscope/memory/_memory_base.py)
</cite>

## 目录
1. [简介](#简介)
2. [AgentBase基类接口详解](#agentbase基类接口详解)
3. [智能体扩展机制](#智能体扩展机制)
4. [状态管理与生命周期控制](#状态管理与生命周期控制)
5. [工具集成与记忆系统](#工具集成与记忆系统)
6. [消息处理与钩子函数](#消息处理与钩子函数)
7. [智能体注册与调用流程](#智能体注册与调用流程)
8. [深度研究智能体实现案例](#深度研究智能体实现案例)
9. [最佳实践与错误处理](#最佳实践与错误处理)

## 简介
本文档详细介绍了在AgentScope框架中创建自定义智能体的完整指南。文档深入解析了AgentBase基类的接口定义和扩展机制，通过逐步示例展示如何继承AgentBase创建新的智能体类型。同时，文档涵盖了智能体状态管理、生命周期控制、错误处理的最佳实践，以及工具集成、记忆系统连接和消息处理的实现方法。

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L1-L733)
- [react_agent_base.py](file://src/agentscope/agent/_react_agent_base.py#L1-L117)

## AgentBase基类接口详解
AgentBase是所有智能体的基类，提供了基本接口和钩子函数。该基类定义了智能体的核心功能，包括回复、观察和打印消息等抽象方法。

```mermaid
classDiagram
class AgentBase {
+id : str
+supported_hook_types : list[str]
+__init__()
+observe(msg : Msg | list[Msg] | None) None
+reply(*args : Any, **kwargs : Any) Msg
+print(msg : Msg, last : bool, speech : AudioBlock | list[AudioBlock] | None) None
+interrupt(msg : Msg | list[Msg] | None) None
+handle_interrupt(*args : Any, **kwargs : Any) Msg
+register_instance_hook(hook_type : str, hook_name : str, hook : Callable) None
+remove_instance_hook(hook_type : str, hook_name : str) None
+register_class_hook(hook_type : str, hook_name : str, hook : Callable) None
+remove_class_hook(hook_type : str, hook_name : str) None
+clear_class_hooks(hook_type : str | None) None
+clear_instance_hooks(hook_type : str | None) None
}
class ReActAgentBase {
+supported_hook_types : list[str]
+_reasoning(*args : Any, **kwargs : Any) Any
+_acting(*args : Any, **kwargs : Any) Any
}
AgentBase <|-- ReActAgentBase
```

**Diagram sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L30-L733)
- [react_agent_base.py](file://src/agentscope/agent/_react_agent_base.py#L12-L117)

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L30-L733)
- [react_agent_base.py](file://src/agentscope/agent/_react_agent_base.py#L12-L117)

## 智能体扩展机制
开发者可以通过继承AgentBase或ReActAgentBase来创建自定义智能体。ReActAgentBase扩展了AgentBase，增加了_reacting和_acting抽象方法，以及它们的前置和后置钩子函数。

```mermaid
classDiagram
class AgentBase {
<<abstract>>
}
class ReActAgentBase {
<<abstract>>
}
class ReActAgent {
+finish_function_name : str
+__init__(name : str, sys_prompt : str, model : ChatModelBase, formatter : FormatterBase, ...)
+reply(msg : Msg | list[Msg] | None, structured_model : Type[BaseModel] | None) Msg
+_reasoning(tool_choice : str | None) Msg
+_acting(tool_call : ToolUseBlock) dict | None
+observe(msg : Msg | list[Msg] | None) None
+_summarizing() Msg
+handle_interrupt(msg : Msg | list[Msg] | None, structured_model : Type[BaseModel] | None) Msg
+generate_response(**kwargs : Any) ToolResponse
}
AgentBase <|-- ReActAgentBase
ReActAgentBase <|-- ReActAgent
```

**Diagram sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L30-L733)
- [react_agent_base.py](file://src/agentscope/agent/_react_agent_base.py#L12-L117)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L40-L867)

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L30-L733)
- [react_agent_base.py](file://src/agentscope/agent/_react_agent_base.py#L12-L117)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L40-L867)

## 状态管理与生命周期控制
智能体的状态管理通过StateModule实现，支持自动和嵌套状态管理。每个智能体都有唯一的ID，通过shortuuid生成。智能体的生命周期包括初始化、回复、观察和中断处理等阶段。

```mermaid
sequenceDiagram
participant User as "用户"
participant Agent as "智能体"
participant Memory as "记忆系统"
User->>Agent : 发送消息
Agent->>Memory : 存储输入消息
Agent->>Agent : 执行回复逻辑
loop 推理-行动循环
Agent->>Agent : _reasoning()
Agent->>Agent : _acting()
alt 需要工具调用
Agent->>Agent : 调用工具
Agent->>Memory : 存储工具结果
end
end
Agent->>Memory : 存储最终回复
Agent->>User : 返回回复消息
```

**Diagram sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L140-L733)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L253-L408)

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L140-L733)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L253-L408)

## 工具集成与记忆系统
智能体通过Toolkit集成各种工具，支持API调用、文件操作、网络搜索等功能。记忆系统包括短期记忆和长期记忆，用于存储对话历史和持久化信息。

```mermaid
classDiagram
class Toolkit {
+tools : dict
+tool_groups : dict
+register_tool_function(tool_func : Callable, group_name : str | None) None
+remove_tool_function(tool_name : str) None
+get_json_schemas() list[dict]
+call_tool_function(tool_call : ToolUseBlock) AsyncGenerator
+reset_equipped_tools(tool_names : list[str]) None
}
class MemoryBase {
<<abstract>>
+add(msg : Msg | list[Msg] | None) None
+get_memory() list[Msg]
+clear() None
}
class InMemoryMemory {
+add(msg : Msg | list[Msg] | None) None
+get_memory() list[Msg]
+clear() None
}
class LongTermMemoryBase {
<<abstract>>
+retrieve(msg : Msg | list[Msg] | None) str
+record(messages : list[Msg]) None
}
MemoryBase <|-- InMemoryMemory
MemoryBase <|-- LongTermMemoryBase
```

**Diagram sources**
- [toolkit.py](file://src/agentscope/tool/_toolkit.py#L1-L100)
- [memory_base.py](file://src/agentscope/memory/_memory_base.py#L1-L50)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L171-L185)

**Section sources**
- [toolkit.py](file://src/agentscope/tool/_toolkit.py#L1-L100)
- [memory_base.py](file://src/agentscope/memory/_memory_base.py#L1-L50)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L171-L185)

## 消息处理与钩子函数
智能体的消息处理机制包括预处理和后处理钩子函数，允许在回复、观察和打印消息前后插入自定义逻辑。钩子函数分为类级别和实例级别，支持灵活的扩展。

```mermaid
flowchart TD
Start([开始]) --> PreReplyHook["执行预回复钩子"]
PreReplyHook --> ReplyLogic["执行回复逻辑"]
ReplyLogic --> PostReplyHook["执行后回复钩子"]
PostReplyHook --> PrePrintHook["执行预打印钩子"]
PrePrintHook --> PrintLogic["执行打印逻辑"]
PrintLogic --> PostPrintHook["执行后打印钩子"]
PostPrintHook --> End([结束])
style Start fill:#f9f,stroke:#333,stroke-width:2px
style End fill:#f9f,stroke:#333,stroke-width:2px
```

**Diagram sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L46-L138)
- [agent_meta.py](file://src/agentscope/agent/_agent_meta.py#L147-L181)

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L46-L138)
- [agent_meta.py](file://src/agentscope/agent/_agent_meta.py#L147-L181)

## 智能体注册与调用流程
智能体的注册和调用流程包括创建智能体实例、注册工具、设置记忆系统和调用回复方法。通过__call__方法，智能体可以像函数一样被调用。

```mermaid
sequenceDiagram
participant User as "用户"
participant Agent as "智能体"
participant Toolkit as "工具包"
participant Memory as "记忆系统"
User->>Agent : 创建智能体实例
Agent->>Toolkit : 注册工具函数
Agent->>Memory : 设置记忆系统
User->>Agent : 调用智能体
Agent->>Agent : __call__()方法
Agent->>Agent : 执行reply()方法
Agent->>Memory : 添加输入消息
loop 推理-行动循环
Agent->>Agent : _reasoning()
Agent->>Agent : _acting()
end
Agent->>Memory : 添加回复消息
Agent->>User : 返回回复
```

**Diagram sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L444-L463)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L253-L408)

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L444-L463)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L253-L408)

## 深度研究智能体实现案例
深度研究智能体是一个复杂的自定义智能体示例，展示了如何实现高级研究任务。该智能体通过分解子任务、扩展查询和深度搜索来完成复杂的研究任务。

```mermaid
classDiagram
class DeepResearchAgent {
+prompt_dict : dict
+max_depth : int
+max_tool_results_words : int
+tmp_file_storage_dir : str
+current_subtask : list[SubTaskItem]
+intermediate_memory : list[Msg]
+__init__(name : str, model : ChatModelBase, formatter : FormatterBase, memory : MemoryBase, search_mcp_client : StatefulClientBase, ...)
+reply(msg : Msg | list[Msg] | None, structured_model : Type[BaseModel] | None) Msg
+_acting(tool_call : ToolUseBlock) Msg | None
+get_model_output(msgs : list, format_template : Type[BaseModel], stream : bool) Any
+call_specific_tool(func_name : str, params : dict) tuple[Msg, Msg]
+decompose_and_expand_subtask() ToolResponse
+_follow_up(search_results : list | str, tool_call : ToolUseBlock) ToolResponse
+summarize_intermediate_results() ToolResponse
}
class SubTaskItem {
+objective : str
+working_plan : str | None
+knowledge_gaps : str | None
}
ReActAgent <|-- DeepResearchAgent
```

**Diagram sources**
- [deep_research_agent.py](file://examples/agent/deep_research_agent/deep_research_agent.py#L65-L800)
- [main.py](file://examples/agent/deep_research_agent/main.py#L16-L84)

**Section sources**
- [deep_research_agent.py](file://examples/agent/deep_research_agent/deep_research_agent.py#L65-L800)
- [main.py](file://examples/agent/deep_research_agent/main.py#L16-L84)

## 最佳实践与错误处理
在创建自定义智能体时，应遵循最佳实践，包括合理使用钩子函数、正确管理状态和实现健壮的错误处理机制。智能体应能够处理中断、超时和工具调用失败等异常情况。

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 等待消息
等待消息 --> 处理消息 : 接收到消息
处理消息 --> 推理 : 开始推理
推理 --> 行动 : 生成工具调用
行动 --> 处理消息 : 工具执行完成
推理 --> 生成回复 : 生成文本回复
生成回复 --> 等待消息
处理消息 --> 总结 : 达到最大迭代次数
总结 --> 等待消息
等待消息 --> [*] : 停止
处理消息 --> 错误处理 : 发生错误
错误处理 --> 等待消息 : 恢复
处理消息 --> [*] : 被中断
```

**Diagram sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L474-L484)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L658-L687)

**Section sources**
- [agent_base.py](file://src/agentscope/agent/_agent_base.py#L474-L484)
- [react_agent.py](file://src/agentscope/agent/_react_agent.py#L658-L687)